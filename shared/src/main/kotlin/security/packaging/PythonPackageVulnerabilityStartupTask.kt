package security.packaging

import com.intellij.openapi.application.ApplicationManager
import com.intellij.openapi.diagnostic.Logger
import com.intellij.openapi.progress.ProgressIndicator
import com.intellij.openapi.progress.ProgressManager
import com.intellij.openapi.progress.Task.Backgroundable
import com.intellij.openapi.project.Project
import com.intellij.openapi.startup.StartupActivity

class PythonPackageVulnerabilityStartupTask : StartupActivity.Background {
    private val LOG = Logger.getInstance(PythonPackageVulnerabilityStartupTask::class.java)

    override fun runActivity(project: Project) {
        val application = ApplicationManager.getApplication()
        if (application.isUnitTestMode) return
        if (project.isDisposed) return

        ProgressManager.getInstance().run(object : Backgroundable(project, "Checking Python packages for known CVEs", false) {
            override fun run(indicator: ProgressIndicator) {
                LOG.info("Checking Python packages for known security vulnerabilities.")
                PyPackageSecurityScan.checkPackages(project)
            }
        })
    }
}